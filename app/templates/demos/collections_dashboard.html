{% extends "base.html" %}
{% set page_title = "Collections Management Dashboard Demo" %}
{% set page_description = "Interactive AR collections dashboard with DSO analytics and collector performance tracking" %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 to-orange-50 dark:from-slate-900 dark:to-slate-800">
    <!-- Demo Header -->
    <div class="bg-white dark:bg-slate-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
        <div class="mx-auto max-w-7xl px-6 lg:px-8 py-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Collections Management Dashboard</h1>
                    <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">
                        Comprehensive AR collections dashboard with DSO analytics and performance tracking
                    </p>
                </div>
                <div class="flex items-center gap-4">
                    <div id="session-status" class="flex items-center text-sm text-gray-600 dark:text-gray-300">
                        <div class="h-2 w-2 bg-yellow-400 rounded-full mr-2"></div>
                        Initializing...
                    </div>
                    <button id="refresh-btn" class="bg-orange-600 text-white px-3 py-1 rounded-md hover:bg-orange-700 transition-colors text-sm">
                        Refresh Data
                    </button>
                    <div class="flex gap-4">
                        <a href="/projects/8" class="text-sm text-orange-600 hover:text-orange-500 dark:text-orange-400">
                            üìã Project Details
                        </a>
                        <a href="/demos" class="text-sm text-blue-600 hover:text-blue-500 dark:text-blue-400">
                            ‚Üê Back to Demos
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div class="mx-auto max-w-7xl px-6 lg:px-8 py-8">
        
        <!-- DSO Metrics Section -->
        <div class="mb-8 error-boundary" data-error-context="dso-metrics-section">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">DSO Analytics & Performance</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                
                <!-- Current DSO -->
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Current DSO</p>
                            <p id="current-dso" class="text-3xl font-bold text-gray-900 dark:text-white">--</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">days</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-500 dark:text-gray-400">Target: <span id="target-dso">--</span></p>
                            <div class="w-16 h-2 bg-gray-200 dark:bg-gray-600 rounded-full mt-1">
                                <div id="dso-progress" class="h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DSO Trend -->
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-300">DSO Trend</p>
                            <p id="dso-change" class="text-2xl font-bold">--</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">vs previous month</p>
                        </div>
                        <div id="dso-trend-icon" class="text-gray-400">
                            <!-- Trend icon will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Industry Benchmark -->
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Industry Benchmark</p>
                            <p id="industry-benchmark" class="text-2xl font-bold text-gray-900 dark:text-white">--</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">days</p>
                        </div>
                        <div class="text-right">
                            <p id="benchmark-comparison" class="text-xs">--</p>
                        </div>
                    </div>
                </div>

                <!-- Collection Efficiency -->
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Collection Rate</p>
                            <p id="collection-rate" class="text-2xl font-bold text-green-600">--%</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">month to date</p>
                        </div>
                        <div class="w-12 h-12 relative">
                            <svg class="w-12 h-12 transform -rotate-90" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" class="text-gray-200 dark:text-gray-600"/>
                                <circle id="collection-circle" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" 
                                        class="text-green-600" stroke-dasharray="0 62.83" stroke-linecap="round"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="grid lg:grid-cols-12 gap-8 mb-8 error-boundary" data-error-context="dashboard-grid-section">
            
            <!-- Aging Analysis -->
            <div class="lg:col-span-6">
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">AR Aging Analysis</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300">Outstanding balances by aging bucket</p>
                    </div>
                    <div class="p-6">
                        <div id="aging-chart" class="h-64">
                            <!-- Aging chart will be rendered here -->
                            <div class="flex items-center justify-center h-full text-gray-500 dark:text-gray-400">
                                <div class="text-center">
                                    <svg class="animate-spin h-8 w-8 mx-auto mb-2" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Loading aging data...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collector Performance Ranking -->
            <div class="lg:col-span-6">
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Collector Performance</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300">Month-to-date collections ranking</p>
                    </div>
                    <div class="p-6">
                        <div id="collector-ranking" class="space-y-4">
                            <!-- Collector performance cards will be inserted here -->
                            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                                <svg class="animate-spin h-8 w-8 mx-auto mb-2" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Loading collector data...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customer Target List -->
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 mb-8">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Priority Customer Target List</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300">Customers requiring immediate collection attention</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <select id="risk-filter" aria-label="Filter by risk level" class="rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-700 px-3 py-1 text-sm">
                            <option value="">All Risk Levels</option>
                            <option value="high">High Risk</option>
                            <option value="medium">Medium Risk</option>
                            <option value="low">Low Risk</option>
                        </select>
                        <input type="text" id="customer-search" placeholder="Search customers..." aria-label="Search customers"
                               class="rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-700 px-3 py-1 text-sm">
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <div class="overflow-x-auto">
                    <table id="customer-table" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-slate-700">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Priority
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Customer
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Outstanding
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Days Past Due
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Risk Score
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Assigned Collector
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Next Action
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Payment Promise
                                </th>
                            </tr>
                        </thead>
                        <tbody id="customer-tbody" class="bg-white dark:bg-slate-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Dynamic customer rows -->
                        </tbody>
                    </table>
                </div>

                <!-- Loading State -->
                <div id="loading-customers" class="text-center py-8" role="status" aria-live="polite">
                    <div class="inline-flex items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-orange-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Loading customer data...
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Summary -->
        <div class="grid lg:grid-cols-3 gap-6">
            
            <!-- Collection Activities -->
            <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Collection Activities</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300">Team activity summary</p>
                </div>
                <div class="p-6">
                    <div id="activity-summary" class="space-y-4">
                        <!-- Activity metrics will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Performance Insights -->
            <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Performance Insights</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300">Key insights and recommendations</p>
                </div>
                <div class="p-6">
                    <div id="insights-content" class="space-y-4">
                        <!-- Insights will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Quick Actions</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300">Common collection tasks</p>
                </div>
                <div class="p-6">
                    <div class="space-y-3">
                        <button class="w-full text-left p-3 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">Generate Dunning Letters</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Send automated collection notices</div>
                        </button>
                        <button class="w-full text-left p-3 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">Schedule Follow-ups</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Create automated reminder tasks</div>
                        </button>
                        <button class="w-full text-left p-3 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">Export Reports</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Download collection analytics</div>
                        </button>
                        <button class="w-full text-left p-3 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">Assign Workloads</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Distribute accounts to collectors</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Chart.js for visualizations -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
<script src="/static/js/chart-utils.js"></script>
<script src="/static/js/websocket-client.js"></script>
<script src="/static/js/user-preferences.js"></script>
<script src="/static/js/preferences-ui.js"></script>
<script src="/static/js/analytics-tracker.js"></script>
<script src="/static/js/performance-monitor.js"></script>
<script src="/static/js/analytics-dashboard.js"></script>
<script src="/static/js/error-handler.js"></script>
<script src="/static/js/connection-manager.js"></script>
<script src="/static/js/error-boundary.js"></script>

<!-- JavaScript for Demo Functionality -->
<script>
let demoSession = null;
let collectionsData = null;
let customerTargets = [];
let charts = {};

// Initialize demo session
async function initializeDemo() {
    try {
        const response = await window.connectionManager.fetch('/demos/api/collections/session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            demoSession = result.data.session_id;
            updateSessionStatus('Connected', 'green');
            
            // Initialize analytics tracking
            if (window.demoAnalytics) {
                window.demoAnalytics.trackDemoStart('collections_dashboard', demoSession, {
                    userAgent: navigator.userAgent,
                    screenResolution: `${screen.width}x${screen.height}`
                });
            }
            
            // Apply user preferences if available
            if (window.userPreferences) {
                window.userPreferences.applyTheme();
            }
            
            await loadCollectionsData();
        } else {
            updateSessionStatus('Error', 'red');
            console.error('Failed to initialize demo session');
        }
    } catch (error) {
        updateSessionStatus('Error', 'red');
        console.error('Error initializing demo:', error);
        console.error('Error details:', error.message, error.stack);
        
        // Use error handler for recovery
        if (window.errorHandler) {
            const errorInfo = {
                type: 'demo_initialization_error',
                message: `Collections demo initialization failed: ${error.message}`,
                error: error,
                context: 'demo_initialization',
                timestamp: Date.now(),
                severity: 'high'
            };
            
            window.errorHandler.handleError(errorInfo);
        }
    }
}

// Update session status indicator
function updateSessionStatus(status, color) {
    const colorClasses = {
        green: 'h-2 w-2 bg-green-400 rounded-full mr-2',
        red: 'h-2 w-2 bg-red-400 rounded-full mr-2',
        yellow: 'h-2 w-2 bg-yellow-400 rounded-full mr-2',
        blue: 'h-2 w-2 bg-blue-400 rounded-full mr-2'
    };
    const statusElement = document.getElementById('session-status');
    const dot = statusElement.querySelector('div');
    const text = statusElement.querySelector('span') || statusElement.childNodes[2];

    dot.className = colorClasses[color] || colorClasses.yellow;
    text.textContent = status;
}

// Load collections dashboard data
async function loadCollectionsData() {
    try {
        const response = await window.connectionManager.fetch('/demos/api/collections/data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: demoSession
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            collectionsData = result.data;
            customerTargets = collectionsData.customer_targets;
            
            renderDSOMetrics(collectionsData.dso_metrics);
            renderAgingChart(collectionsData.aging_analysis);
            renderCollectorPerformance(collectionsData.collector_performance);
            renderCustomerTable(customerTargets);
            renderActivitySummary(collectionsData.collector_performance);
            renderInsights();
            
            // Hide loading indicators
            document.getElementById('loading-customers').style.display = 'none';
        } else {
            showError(result.message || 'Failed to load collections data');
        }
    } catch (error) {
        showError(`Error loading collections data: ${error.message}`);
    }
}

// Render DSO metrics
function renderDSOMetrics(dsoData) {
    document.getElementById('current-dso').textContent = dsoData.current_dso.toFixed(1);
    document.getElementById('target-dso').textContent = dsoData.target_dso.toFixed(0);
    document.getElementById('industry-benchmark').textContent = dsoData.industry_benchmark.toFixed(0);
    
    // Calculate DSO progress
    const dsoProgress = Math.min((dsoData.target_dso / dsoData.current_dso) * 100, 100);
    const progressBar = document.getElementById('dso-progress');
    const progressColor = dsoProgress >= 80 ? 'bg-green-600' : dsoProgress >= 60 ? 'bg-yellow-600' : 'bg-red-600';
    progressBar.className = `h-2 rounded-full ${progressColor}`;
    progressBar.style.width = `${dsoProgress}%`;
    
    // DSO trend
    const previousDSO = dsoData.previous_month_dso;
    const change = dsoData.current_dso - previousDSO;
    const changePercent = ((change / previousDSO) * 100);
    const isImproving = change < 0; // Lower DSO is better
    
    document.getElementById('dso-change').textContent = `${change > 0 ? '+' : ''}${change.toFixed(1)}`;
    document.getElementById('dso-change').className = `text-2xl font-bold ${isImproving ? 'text-green-600' : 'text-red-600'}`;
    
    const trendIcon = isImproving 
        ? '<svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd" transform="rotate(180)"></path></svg>'
        : '<svg class="w-6 h-6 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
    
    document.getElementById('dso-trend-icon').innerHTML = trendIcon;
    
    // Benchmark comparison
    const benchmarkDiff = dsoData.current_dso - dsoData.industry_benchmark;
    const benchmarkColor = benchmarkDiff <= 0 ? 'text-green-600' : 'text-red-600';
    document.getElementById('benchmark-comparison').textContent = `${benchmarkDiff > 0 ? '+' : ''}${benchmarkDiff.toFixed(1)} vs industry`;
    document.getElementById('benchmark-comparison').className = `text-xs ${benchmarkColor}`;
    
    // Collection rate (calculated)
    const collectionRate = 72.5; // Simulated collection rate
    document.getElementById('collection-rate').textContent = `${collectionRate.toFixed(1)}%`;
    
    // Update collection rate circle
    const circumference = 2 * Math.PI * 10;
    const offset = circumference - (collectionRate / 100) * circumference;
    document.getElementById('collection-circle').style.strokeDasharray = `${circumference} ${circumference}`;
    document.getElementById('collection-circle').style.strokeDashoffset = offset;
}

// Render aging chart
function renderAgingChart(agingData) {
    try {
        const ctx = document.getElementById('aging-chart');
        
        if (charts.aging) {
            charts.aging.destroy();
        }
        
        // Clear loading state
        ctx.innerHTML = '<canvas></canvas>';
        const canvas = ctx.querySelector('canvas');
    
    const labels = agingData.map(bucket => bucket.bucket_name);
    const amounts = agingData.map(bucket => bucket.amount);
    const counts = agingData.map(bucket => bucket.count);
    
    charts.aging = new Chart(canvas, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: amounts,
                backgroundColor: [
                    'rgb(34, 197, 94)',   // Current - Green
                    'rgb(250, 204, 21)',  // 30 Days - Yellow
                    'rgb(251, 146, 60)',  // 60 Days - Orange
                    'rgb(239, 68, 68)'    // 90+ Days - Red
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const bucket = agingData[context.dataIndex];
                            return `${bucket.bucket_name}: $${formatNumber(bucket.amount)} (${bucket.count} invoices)`;
                        }
                    }
                }
            }
        }
    });
    } catch (error) {
        // Handle chart rendering error
        const errorInfo = {
            type: 'chart_error',
            message: `Failed to render aging chart: ${error.message}`,
            error: error,
            context: 'aging-chart-section',
            chartType: 'aging_analysis',
            timestamp: Date.now(),
            severity: 'medium'
        };
        
        if (window.errorHandler) {
            window.errorHandler.handleError(errorInfo);
        }
    }
}

// Render collector performance
function renderCollectorPerformance(collectors) {
    const container = document.getElementById('collector-ranking');
    container.innerHTML = '';
    
    collectors.forEach((collector, index) => {
        const targetProgress = (collector.collections_mtd / collector.target_mtd) * 100;
        const targetColor = targetProgress >= 100 ? 'bg-green-600' : targetProgress >= 80 ? 'bg-yellow-600' : 'bg-red-600';
        
        const card = document.createElement('div');
        card.className = 'flex items-center justify-between p-4 bg-gray-50 dark:bg-slate-700 rounded-lg';
        
        card.innerHTML = `
            <div class="flex items-center">
                <div class="flex items-center justify-center w-8 h-8 rounded-full ${index < 3 ? 'bg-orange-600' : 'bg-gray-400'} text-white text-sm font-bold mr-3">
                    ${index + 1}
                </div>
                <div>
                    <div class="text-sm font-medium text-gray-900 dark:text-white">${collector.collector_name}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">${collector.accounts_assigned} accounts assigned</div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-sm font-medium text-gray-900 dark:text-white">$${formatNumber(collector.collections_mtd)}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">${targetProgress.toFixed(0)}% of target</div>
                <div class="w-16 h-1 bg-gray-200 dark:bg-gray-600 rounded-full mt-1">
                    <div class="h-1 rounded-full ${targetColor}" style="width: ${Math.min(targetProgress, 100)}%"></div>
                </div>
            </div>
        `;
        
        container.appendChild(card);
    });
}

// Render customer table
function renderCustomerTable(customers) {
    const tbody = document.getElementById('customer-tbody');
    tbody.innerHTML = '';

    if (!customers || customers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">No customers match the current filters.</td></tr>';
        return;
    }

    customers.forEach(customer => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 dark:hover:bg-slate-700';
        
        const riskColor = getRiskColor(customer.risk_score);
        const priorityColor = getPriorityColor(customer.priority_rank);
        const actionColor = getActionColor(customer.next_action);
        
        row.innerHTML = `
            <td class="px-4 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${priorityColor}">
                    #${customer.priority_rank}
                </span>
            </td>
            <td class="px-4 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900 dark:text-white">${customer.customer_name}</div>
                <div class="text-sm text-gray-500">${customer.customer_id}</div>
            </td>
            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                $${formatNumber(customer.total_outstanding)}
            </td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                ${customer.days_past_due} days
            </td>
            <td class="px-4 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${riskColor}">
                    ${customer.risk_score.charAt(0).toUpperCase() + customer.risk_score.slice(1)}
                </span>
            </td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                ${customer.assigned_collector}
            </td>
            <td class="px-4 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${actionColor}">
                    ${formatAction(customer.next_action)}
                </span>
            </td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                ${customer.payment_promise ? 
                    `$${formatNumber(customer.payment_promise.amount)}<br>
                     <span class="text-xs">${formatDate(customer.payment_promise.promise_date)}</span>` 
                    : 'None'}
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// Render activity summary
function renderActivitySummary(collectors) {
    const totalCalls = collectors.reduce((sum, c) => sum + c.calls_made, 0);
    const totalEmails = collectors.reduce((sum, c) => sum + c.emails_sent, 0);
    const totalMeetings = collectors.reduce((sum, c) => sum + c.meetings_held, 0);
    const avgSuccessRate = (collectors.reduce((sum, c) => sum + c.success_rate, 0) / collectors.length) * 100;
    
    const content = document.getElementById('activity-summary');
    content.innerHTML = `
        <div class="flex justify-between items-center">
            <span class="text-sm text-gray-600 dark:text-gray-300">Total Calls Made</span>
            <span class="text-lg font-semibold text-gray-900 dark:text-white">${totalCalls}</span>
        </div>
        <div class="flex justify-between items-center">
            <span class="text-sm text-gray-600 dark:text-gray-300">Emails Sent</span>
            <span class="text-lg font-semibold text-gray-900 dark:text-white">${totalEmails}</span>
        </div>
        <div class="flex justify-between items-center">
            <span class="text-sm text-gray-600 dark:text-gray-300">Customer Meetings</span>
            <span class="text-lg font-semibold text-gray-900 dark:text-white">${totalMeetings}</span>
        </div>
        <div class="flex justify-between items-center">
            <span class="text-sm text-gray-600 dark:text-gray-300">Avg Success Rate</span>
            <span class="text-lg font-semibold text-green-600">${avgSuccessRate.toFixed(1)}%</span>
        </div>
    `;
}

// Render insights
function renderInsights() {
    const highRiskCustomers = customerTargets.filter(c => c.risk_score === 'high').length;
    const overdueCustomers = customerTargets.filter(c => c.days_past_due > 60).length;
    const promisedPayments = customerTargets.filter(c => c.payment_promise).length;
    
    const content = document.getElementById('insights-content');
    content.innerHTML = `
        <div class="space-y-4">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div class="flex items-center justify-center h-6 w-6 rounded-full bg-red-100">
                        <svg class="h-4 w-4 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-3">
                    <h4 class="text-sm font-medium text-gray-900 dark:text-white">High Risk Accounts</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-300">
                        ${highRiskCustomers} customer${highRiskCustomers !== 1 ? 's' : ''} at high churn risk requiring immediate attention.
                    </p>
                </div>
            </div>
            
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div class="flex items-center justify-center h-6 w-6 rounded-full bg-orange-100">
                        <svg class="h-4 w-4 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-3">
                    <h4 class="text-sm font-medium text-gray-900 dark:text-white">Overdue Focus</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-300">
                        ${overdueCustomers} accounts over 60 days past due need escalated collection efforts.
                    </p>
                </div>
            </div>
            
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div class="flex items-center justify-center h-6 w-6 rounded-full bg-green-100">
                        <svg class="h-4 w-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-3">
                    <h4 class="text-sm font-medium text-gray-900 dark:text-white">Payment Promises</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-300">
                        ${promisedPayments} customer${promisedPayments !== 1 ? 's' : ''} have active payment promises to track.
                    </p>
                </div>
            </div>
        </div>
    `;
}

// Utility functions
function getRiskColor(risk) {
    switch (risk) {
        case 'high': return 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300';
        case 'medium': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300';
        default: return 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300';
    }
}

function getPriorityColor(priority) {
    return priority <= 2 ? 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300' :
           priority <= 4 ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300' :
           'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300';
}

function getActionColor(action) {
    switch (action) {
        case 'phone_call': return 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300';
        case 'email_follow_up': return 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300';
        case 'meeting_scheduled': return 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300';
        case 'payment_plan': return 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300';
        default: return 'bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-300';
    }
}

function formatAction(action) {
    return action.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
}

function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(0) + 'K';
    }
    return num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString();
}

function showError(message) {
    console.error(message);
    const targetList = document.getElementById('loading-customers');
    if (targetList) {
        targetList.innerHTML = `
            <div class="text-center py-4 text-red-600 dark:text-red-400" role="alert">
                <p class="font-medium">Error loading data</p>
                <p class="text-sm mt-1">${message}</p>
                <button onclick="loadCollectionsData()" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm">
                    Retry
                </button>
            </div>
        `;
    }
}

// Event handlers
document.getElementById('refresh-btn').addEventListener('click', loadCollectionsData);

// Filter functionality
document.getElementById('risk-filter').addEventListener('change', function(e) {
    const riskLevel = e.target.value;
    const searchTerm = document.getElementById('customer-search').value.toLowerCase();
    
    let filteredCustomers = customerTargets;
    
    if (riskLevel) {
        filteredCustomers = filteredCustomers.filter(c => c.risk_score === riskLevel);
    }
    
    if (searchTerm) {
        filteredCustomers = filteredCustomers.filter(c => 
            c.customer_name.toLowerCase().includes(searchTerm) ||
            c.customer_id.toLowerCase().includes(searchTerm)
        );
    }
    
    renderCustomerTable(filteredCustomers);
});

// Debounce utility
function debounce(fn, delay) {
    let timer;
    return function(...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
    };
}

document.getElementById('customer-search').addEventListener('input', debounce(function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const riskLevel = document.getElementById('risk-filter').value;
    
    let filteredCustomers = customerTargets;
    
    if (riskLevel) {
        filteredCustomers = filteredCustomers.filter(c => c.risk_score === riskLevel);
    }
    
    if (searchTerm) {
        filteredCustomers = filteredCustomers.filter(c => 
            c.customer_name.toLowerCase().includes(searchTerm) ||
            c.customer_id.toLowerCase().includes(searchTerm)
        );
    }
    
    renderCustomerTable(filteredCustomers);
}, 300));

// Initialize demo when page loads
document.addEventListener('DOMContentLoaded', () => {
    // Initialize error boundaries first
    if (window.ErrorBoundary) {
        window.ErrorBoundary.create('.error-boundary', {
            retryable: true,
            logErrors: true,
            onError: (error, boundary) => {
                // Custom error handling for demo context
                if (window.demoAnalytics) {
                    window.demoAnalytics.trackError(error, {
                        boundaryId: boundary.getBoundaryId(),
                        context: boundary.element.getAttribute('data-error-context')
                    });
                }
            }
        });
    }
    
    initializeDemo();
    
    // Initialize analytics if available
    if (window.demoAnalytics) {
        // Analytics is already initialized in constructor, no need to call initialize
    }
    
    // Initialize performance monitoring
    if (window.performanceMonitor) {
        window.performanceMonitor.startMonitoring('collections_dashboard');
    }
});
</script>
{% endblock %}